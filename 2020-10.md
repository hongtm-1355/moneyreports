> BÃ i viáº¿t Ä‘Æ°á»£c dá»‹ch tá»«: https://overreacted.io/a-complete-guide-to-useeffect/

Báº¡n Ä‘Ã£ tá»«ng sá»­ dá»¥ng Hooks Ä‘á»ƒ viáº¿t component. Ká»ƒ cáº£ chá»‰ lÃ  má»™t á»©ng dá»¥ng nhá». Báº¡n hÃ i lÃ²ng vá»›i nÃ³. Báº¡n cáº£m tháº¥y thoáº£i mÃ¡i vá»›i API vÃ  náº¯m Ä‘Æ°á»£c má»™t vÃ i tricks trong quÃ¡ trÃ¬nh sá»­ dá»¥ng. Báº¡n tháº­m chÃ­ Ä‘Ã£ thá»±c hiá»‡n má»™t vÃ i `custom Hook` Ä‘á»ƒ thá»±c hiá»‡n má»™t logic nÃ o Ä‘Ã³ vÃ  Ä‘Æ°a cho Ä‘á»“ng nghiá»‡p cá»§a báº¡n. Há» sáº½ nÃ³i: "Great job".

NhÆ°ng thá»‰nh thoáº£ng khi báº¡n sá»­ dá»¥ng `useEffect`, sáº½ cÃ³ nhiá»u thá»© khÃ´ng nhÆ° Ã½ muá»‘n. Báº¡n cáº£m tháº¥y khÃ³ chá»‹u khi thiáº¿u thiáº¿u thá»© gÃ¬ Ä‘Ã³. NÃ³ cÃ³ váº» giá»‘ng nhÆ° class lifecycle .... nhÆ°ng cÃ³ tháº­t tháº¿ khÃ´ng ? Báº¡n Ä‘Ã£ tá»«ng Ä‘áº·t cÃ¡c cÃ¢u há»i nhÆ° ?

- LÃ m tháº¿ nÃ o tÃ´i sá»­ dá»¥ng `useEffect` nhÆ° dung `componentDidMount` ?
- LÃ m tháº¿ nÃ o tÃ´i láº¥y chÃ­nh xÃ¡c dá»¯ liá»‡u bÃªn trong `useEffect` ? `[]` lÃ  cÃ¡i gÃ¬ ?
- TÃ´i cÃ³ cáº§n chá»‰ Ä‘á»‹nh má»™t function nhÆ° viá»‡c phá»¥ thuá»™c effect hay khÃ´ng ?
- Táº¡i sao thá»‰nh thoáº£ng tÃ´i gáº·p vÃ²ng láº·p vÃ´ háº¡n ?
- Táº¡i sao thá»‰nh thoáº£ng tÃ´i nháº­n giÃ¡ trá»‹ cÅ© hoáº·c giÃ¡ trá»‹ cÅ© cá»§a props trong my effect.

Khi tÃ´i má»›i báº¯t Ä‘áº§u sá»­ dá»¥ng Hook, tÃ´i Ä‘Ã£ tá»«ng khÃ¡ bá»‘i rá»‘i vá»›i táº¥t cáº£ cÃ¡c cÃ¢u há»i trÃªn. Ká»ƒ cáº£ khi Ä‘ang viáº¿t nhá»¯ng dÃ²ng Ä‘áº§u tiÃªn cá»§a docs, tÃ´i khÃ´ng náº¯m báº¯t Ä‘Æ°á»£c má»™t sá»‘ Ä‘iá»u tinh táº¿. TÃ´i Ä‘Ã£ cÃ³ má»™t vÃ i khoáº£nh kháº¯c mÃ  tÃ´i muá»‘n chia sáº» vá»›i báº¡n. Äi sÃ¢u vÃ o sáº½ tráº£ lá»i nhá»¯ng cÃ¢u há»i báº¡n má»™t cÃ¡ch rÃµ rÃ ng. 

Äá»ƒ tháº¥y nhá»¯ng cÃ¢u tráº£ lá»i, chÃºng ta cáº§n quay láº¡i má»™t chÃºt. Má»¥c tiÃªu cá»§a bÃ i viáº¿t nÃ y khÃ´ng pháº£i cung cáº¥p cho báº¡n má»™t danh sÃ¡ch point recipes. NÃ³ Ä‘á»ƒ giÃºp báº¡n sá»­ dá»¥ng Ä‘Æ°á»£c `useEffect`. Sáº½ khÃ´ng cÃ³ nhiá»u thá»© Ä‘á»ƒ há»c. Sá»± tháº­t , chÃºng ta sáº½ dÃ nh thá»i gian Ä‘á»ƒ unlearning.

NÃ³ chá»‰ sau khi tÃ´i dá»«ng viá»‡c nhÃ¬n `useEffect` Hook thÃ´ng qua lÄƒng kÃ­nh cá»§a lifecycle Ä‘Ã£ quen thuá»™c vá»›i mÃ¬nh.

> Unlearn what you have learned
> KhÃ´ng há»c nhá»¯ng gÃ¬ báº¡n Ä‘Ã£ há»c
> 


----

BÃ i viáº¿t nÃ y giáº£ Ä‘á»‹nh ráº±ng báº¡n Ä‘Ã£ quen vá»›i `useEffect` API.

BÃ i viáº¿t nÃ y cÅ©ng thá»±c sá»± dÃ i. NÃ³ nhÆ° quyá»ƒn mini-book. ÄÃ¢y lÃ  format Æ°a thÃ­ch cá»§a tÃ´i. VÃ  tÃ´i cÃ³ viáº¿t má»™t TLDR phÃ­a dÆ°á»›i náº¿u nhÆ° báº¡n Ä‘ang vá»™i.

----

### TDLR

ÄÃ¢y lÃ  má»™t TLDR náº¿u báº¡n khÃ´ng muá»‘n Ä‘á»c toÃ n bá»™ ná»™i dung. Náº¿u má»™t vÃ i pháº§n khÃ´ng cÃ³ lÃ½ (make sense), báº¡n cÃ³ thá»ƒ cuá»™n xuá»‘ng tá»›i Ä‘oáº¡n Ä‘Ã³ Ä‘á»ƒ Ä‘á»c. 

**ğŸ¤” CÃ¢u há»i: LÃ m tháº¿ nÃ o tÃ´i sá»­ dá»¥ng `useEffect` nhÆ° dung `componentDidMount` ?**

`useEffect(fn, [])` khÃ´ng hoÃ n toÃ n tÆ°Æ¡ng Ä‘Æ°Æ¡ng. KhÃ´ng giá»‘ng `componentDidMount`, nÃ³ sáº½ `capture` props vÃ  state. Vi váº­y, ngay cáº£ khi bÃªn trong má»™t callback, báº¡n sáº½ nhÃ¬n tháº¥y giÃ¡ trá»‹ ban Ä‘áº§u cá»§a props, state. Náº¿u báº¡n muá»‘n tháº¥y giÃ¡ trá»‹ cuá»‘i cÃ¹ng, báº¡n cÃ³ thá»ƒ dÃ¹ng `ref`. But thereâ€™s usually a simpler way to structure the code so that you donâ€™t have to. HÃ£y nhá»› ráº±ng mÃ´ hÃ¬nh effect khÃ¡c so vá»›i `componentDidMount` vÃ  `lifecycle`, viá»‡c cá»‘ tÃ¬m nhá»¯ng Ä‘iá»ƒm tÆ°Æ¡ng Ä‘á»“ng giá»¯a hai mÃ´ hÃ¬nh cÃ³ thÃª khiáº¿n báº¡n cáº£m tháº¥y ráº¯c rá»‘i. HÃ£y "think in effect" vÃ  tinh thÃ¢n cá»§a mÃ´ hÃ¬nh nÃ y sáº½ gáº§n gÅ©i hÆ¡n Ä‘á»ƒ triá»ƒn khai Ä‘á»“ng bá»™ hÆ¡n lÃ  mÃ³c lá»‘i vá»›i `lifecycle`

**ğŸ¤” CÃ¢u há»i: TÃ´i cÃ³ cáº§n chá»‰ Ä‘á»‹nh cÃ¡c function nhÆ° effect dependencies hay khÃ´ng ?**

Äá» xuáº¥t lÃ  hoist cÃ¡c function mÃ  khÃ´ng cáº§n props vÃ  state bÃªn ngoÃ i component vÃ  kÃ©o cÃ¡c funtion chá»‰ Ä‘Æ°á»£c sá»­ dá»¥ng bá»Ÿi má»™t effect. 
......


### Má»—i render sáº½ cÃ³ props vÃ  state riÃªng

TrÆ°á»›c khi chÃºng ta bÃ n tá»›i `effect`, chÃºng ta sáº½ nÃ³i vá» `rendering` trÆ°á»›c.
VÃ­ dá»¥ dÆ°á»›i Ä‘Ã¢y lÃ  má»™t `counter`. 

```js=
function Counter() {
  const [count, setCount] = useState(0);

  return (
    <div>
      <p>You clicked {count} times</p>
      <button onClick={() => setCount(count + 1)}>
        Click me
      </button>
    </div>
  );
}
```

Tá»©c lÃ  sao ? CÃ³ pháº£i `count` sáº½ theo gÃµi sá»± thay Ä‘á»•i state cá»§a chusgn ta vÃ  update nÃ³ má»™t cÃ¡ch tá»± Ä‘á»™ng ?. NÃ³ cÃ³ thá»ƒ lÃ  suy nghÄ© Ä‘áº§u tiÃªn xáº£y ra khi chÃºng ta há»c React nhÆ°ng nÃ³ khÃ´ng chÃ­nh xÃ¡c.

Trong vÃ­ dá»¥ nÃ y, `count` chá»‰ lÃ  má»™t sá»‘. NÃ³ khÃ´ng pháº£i lÃ  má»™t `data binding`, `watcher`, hay `proxy` hay cÃ¡c khÃ¡i niá»‡m tÆ°Æ¡ng Ä‘Æ°Æ¡ng. NÃ³ chá»‰ Ä‘Æ¡n giáº£n lÃ  má»™t sá»‘ nhÆ° bÃªn dÆ°á»›i:

```js=
const count = 42;
// ...
<p>You clicked {count} times</p>
// ...
```

Láº§n Ä‘áº§u component render, biáº¿n `count` Ä‘Æ°á»£c gÃ¡n giÃ¡ trá»‹ tá»« `useState` lÃ  0. Khi chÃºng ta gá»i `setCount(1)`, React sáº½ gá»i component má»™t láº§n ná»¯a. á» thá»i Ä‘iá»ƒm nÃ y, `count` sáº½ báº±ng 1. VÃ 

```js=
// Láº§n render Ä‘áº§u
function Counter() {
  const count = 0; // Returned by useState()
  // ...
  <p>You clicked {count} times</p>
  // ...
}

// Sau khi click, function Ä‘Æ°á»£c gá»i láº¡i
function Counter() {
  const count = 1; // Returned by useState()
  // ...
  <p>You clicked {count} times</p>
  // ...
}

// Sau má»™t láº§n click khÃ¡c, function láº¡i Ä‘Æ°á»£c gá»i láº¡i
function Counter() {
  const count = 2; // Returned by useState()
  // ...
  <p>You clicked {count} times</p>
  // ...
}
```

Báº¥t cá»© khi nÃ o chÃºng ta cáº­p nháº­p state, React sáº½ call láº¡i component cá»§a chÃºng ta. Má»—i káº¿t quáº£ render sáº½ tháº¥y má»™t giÃ¡ trá»‹ counter riÃªng vÃ  `constant` trong function.

```js=
<p>You clicked {count} times</p>
```

VÃ¬ váº­y dÃ²ng bÃªn trÃªn khÃ´ng pháº£i lÃ  data binding.

NÃ³ chá»‰ gÃ¡n má»™t sá»‘ tá»›i output cá»§a render. Sá»‘ nÃ y Ä‘Æ°á»£c cung cáº¥p bá»Ÿi React. Khi chÃºng ta `setCount` React sáº½ gá»i component cá»§a ta láº¡i má»™t láº§n ná»¯a vá»›i `count` value khÃ¡c. Sau Ä‘Ã³ React cáº­p nháº­t DOM Ä‘á»ƒ phÃ¹ há»£p vá»›i Ä‘áº§u ra render má»›i nháº¥t cá»§a chÃºng tÃ´i.

### Má»—i Render sáº½ cÃ³ má»™t Event Handler

Event handers lÃ  gÃ¬ ?

á» vá»‹ dá»¥ nÃ y, nÃ³ sáº½ hiá»‡n ra alert tá»›i giÃ¡ trá»‹ cá»§a `count` sau 3s.

```js=
function Counter() {
  const [count, setCount] = useState(0);

  function handleAlertClick() {
    setTimeout(() => {
      alert('You clicked on: ' + count);
    }, 3000);
  }

  return (
    <div>
      <p>You clicked {count} times</p>
      <button onClick={() => setCount(count + 1)}>
        Click me
      </button>
      <button onClick={handleAlertClick}>
        Show alert
      </button>
    </div>
  );
}
```

HÃ£y Ä‘á»ƒ tÃ´i nÃ³i cÃ¡ch bÆ°á»›c cháº¡y: 
- TÄƒng counter lÃªn 3
- áº¤n show Alert
- TÄƒng lÃªn 5 trÆ°á»›c khi timeout kÃ­ch hoáº¡t

Báº¡n Ä‘ang mong chá» alert sáº½ hiá»‡n gÃ¬ ? NÃ³ sáº½ hiá»‡n 5 - tráº¡ng thÃ¡i counter á»Ÿ thá»i Ä‘iá»ƒm alert? Hay nÃ³ sáº½ hiá»‡n 3 - tráº¡ng thÃ¡i khi ta click.

Go ahead and try it [yourself](https://codesandbox.io/s/w2wxl3yo0l)!

Náº¿u vÃ­ dá»¥ nÃ y khÃ´ng cÃ³ Ã½ nghÄ©a vá»›i báº¡n, thÃ¬ báº¡n hÃ£y tÆ°á»Ÿng tÆ°á»Ÿng: 1 chat app vá»›i state chá»©a ID ngÆ°á»i nháº­n, vÃ  má»™t cÃ¡i button. [BÃ i viáº¿t ](https://overreacted.io/how-are-function-components-different-from-classes/)nÃ y khÃ¡m lÃ½ do sÃ¢u hÆ¡n, nhÆ°ng Ä‘Ã¡p Ã¡n chÃ­nh xÃ¡c lÃ  3.

Aler sáº½ láº¥y cÃ¡i state á»Ÿ thá»i Ä‘iá»ƒm mÃ  ta click button. (CÃ³ nhiá»u cÃ¡ch Ä‘á»ƒ triá»ƒn khai hÃ nh vi Ä‘Ã³, nhÆ°ng chÃºng tÃ´i sáº½ táº­p chung vÃ  trÆ°á»ng há»£p máº·c Ä‘á»‹nh bÃ¢y giá». Khi xÃ¢y dá»±ng má»™t mÃ´ hÃ¬nh tÃ¢m lÃ½, nÃ³ sáº½ quan trá»ng khi chÃºng ta phÃ¢n biá»‡t the â€œpath of least resistanceâ€ from the opt-in escape hatches.

NhÆ°ng lÃ m tháº¿ nÃ o nÃ³ hoáº¡t Ä‘á»™ng ?

ChÃºng ta Ä‘Ã£ tháº£o luáº­n ráº±ng giÃ¡ trá»‹ `count` lÃ  constant khi function cá»§a ta bá»‹ gá»i. HÃ£y nháº«n máº¡nh vÃ o Ä‘iá»u nÃ y, funtion cáº£ ta gá»i nhiá»u láº§n (má»—i láº§n render), nhÆ°ng má»—i láº§n giÃ¡ trá»‹ cá»§a `count` bÃªn trong lÃ  má»™t háº±ng sá»‘ vÃ  set má»™t giÃ¡ trá»‹ cá»¥ thá»ƒ.

ÄÃ¢y khÃ´ng pháº£i specific to React - function bÃ¬nh thÆ°á»ng hoáº¡t Ä‘á»™ng nhÆ° váº­y:

```js
function sayHi(person) {
  const name = person.name;
  setTimeout(() => {
    alert('Hello, ' + name);
  }, 3000);
}

let someone = {name: 'Dan'};
sayHi(someone);

someone = {name: 'Yuzhi'};
sayHi(someone);

someone = {name: 'Dominic'};
sayHi(someone);
```

á» vÃ­ dá»¥ nÃ y, biáº¿n `someone` Ä‘Æ°á»£c gÃ¡n láº¡i nhiá»u láº§n. ( Giá»‘ng trong React, state cá»§a component hiá»‡n táº¡i cÃ³ thá»ƒ thay Ä‘á»•i). Tuy nhiÃªn, bÃªn trong `sayHi`, cÃ³ má»™t const local `name` liÃªn káº¿t vá»›i person tá»« má»™t particular call ( cuá»™c gá»i cá»¥ thá»ƒ). Háº±ng sá»‘ nÃ y lÃ  local, vÃ¬ tháº¿ nÃ³ sáº½ bá»‹ cÃ´ láº­p giá»¯a cÃ¡c cuá»™c gá»i. NhÆ° káº¿t quáº£, khi timeout Ä‘Æ°á»£c Ã­ch hoáº¡t, má»—i alert sáº½ nhá»› cÃ¡i name cá»§a nÃ³.

Äiá»u nÃ y giáº£i thÃ­ch cÃ¡ch mÃ  even handler cá»§a chÃºng ta capture `count` á»Ÿ thá»i Ä‘iá»ƒm ta click chuá»™t. Náº¿u chÃºng ta Ã¡p dá»¥ng cÃ¹ng má»™t nguyÃªn táº¯c, má»—i láº§n renÄ‘er sáº½ cÃ³ má»™t count riÃªng:

```js
// During first render
function Counter() {
  const count = 0; // Returned by useState()
  // ...
  function handleAlertClick() {
    setTimeout(() => {
      alert('You clicked on: ' + count);
    }, 3000);
  }
  // ...
}

// After a click, our function is called again
function Counter() {
  const count = 1; // Returned by useState()
  // ...
  function handleAlertClick() {
    setTimeout(() => {
      alert('You clicked on: ' + count);
    }, 3000);
  }
  // ...
}

// After another click, our function is called again
function Counter() {
  const count = 2; // Returned by useState()
  // ...
  function handleAlertClick() {
    setTimeout(() => {
      alert('You clicked on: ' + count);
    }, 3000);
  }
  // ...
}
```

Má»—i render sáº½ tráº£ láº¡i má»™t `version` of `handleAlertClick`. Má»—i phiÃªn báº£n Ä‘Ã³ sáº½ nhá»› cÃ¡i giÃ¡ trá»‹ cá»§a `count`:

```js
// During first render
function Counter() {
  // ...
  function handleAlertClick() {
    setTimeout(() => {
      alert('You clicked on: ' + 0);
    }, 3000);
  }
  // ...
  <button onClick={handleAlertClick} /> // The one with 0 inside
  // ...
}

// After a click, our function is called again
function Counter() {
  // ...
  function handleAlertClick() {
    setTimeout(() => {
      alert('You clicked on: ' + 1);
    }, 3000);
  }
  // ...
  <button onClick={handleAlertClick} /> // The one with 1 inside
  // ...
}

// After another click, our function is called again
function Counter() {
  // ...
  function handleAlertClick() {
    setTimeout(() => {
      alert('You clicked on: ' + 2);
    }, 3000);
  }
  // ...
  <button onClick={handleAlertClick} /> // The one with 2 inside
  // ...
}
```

ÄÃ³ lÃ  táº¡i sao trong demo cá»§a event hadnler phá»¥ thuá»™c vÃ o má»™t render cá»¥ thá»ƒ, vÃ  khi báº¡n lick, nÃ³ sáº½ tiáº¿p tá»¥c sá»­ dá»¥ng `counter` state tá»« render.

BÃªn trong báº¥t ká»³ má»™t render cá»¥ thá»ƒ, props vÃ  state sáº½ luÃ´n stay the same. NhÆ°ng náº¿u props vÃ  state Ä‘á»™c láº­p giá»¯a cÃ¡c láº§n render thÃ¬ báº¥t ká»³ giÃ¡ trá»‹ nÃ o cÅ©ng cÃ³ thá»ƒ sá»­ dá»¥ng chÃºng. Äiá»u Ä‘Ã³ phá»¥ thuá»™c vÃ o nhá»¯ng láº§n render cá»¥ thá»ƒ. VÃ¬ váº­y, cáº£ nhá»¯ng function báº¥t Ä‘á»“ng bá»™ bÃªn trong 1 event handler sáº½ nhÃ¬n tháº¥y 1 count value.

## CÃ¡c Effect sáº½ Ä‘á»™c láº­p theo má»—i láº§n render

ÄÃ¢y lÃ  bÃ i viáº¿t vá» effect tuy nhiÃªn nÃ£y giá» chÃºng ta váº«n chÆ°a nÃ³i gÃ¬ vá» nÃ³. VÃ  bÃ¢y giá» chÃºng ta sáº½ thá»±c Ä‘á» cáº­p tá»›i nÃ³. Thá»±c cháº¥t, effect khÃ´ng thá»±c sá»± cÃ³ nhiá»u khÃ¡c biá»‡t.

HÃ£y cÃ¹ng xem láº¡i má»™t vÃ­ dá»¥ tá»« [docs](https://reactjs.org/docs/hooks-effect.html):

```js
function Counter() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    document.title = `You clicked ${count} times`;
  });

  return (
    <div>
      <p>You clicked {count} times</p>
      <button onClick={() => setCount(count + 1)}>
        Click me
      </button>
    </div>
  );
}
```

**CÃ³ má»™t cÃ¢u há»i dÃ nh cho báº¡n: lÃ m tháº¿ nÃ o effect cÃ³ thá»ƒ Ä‘á»c tráº¡ng thÃ¡i cuá»‘i cÃ¹ng cá»§a `count` ?**

CÃ³ pháº£i, cÃ³ dáº¡ng kiá»ƒu "data binding" hoáº·c "watching" khiáº¿n `count` Ä‘Æ°á»£c cáº­p nháº­p trá»±c tiáº¿p bÃªn trong effect function ? CÃ³ pháº£i `count` lÃ  mutable variable ( biáº¿n cÃ³ thá»ƒ thay Ä‘á»•i Ä‘Æ°á»£c) mÃ  React set bÃªn trong component vÃ¬ tháº¿ mÃ  effect cá»§a chÃºng ta luÃ´ng luÃ´n nhÃ¬n tháº¥y giÃ¡ trá»‹ má»›i nháº¥t ?

KHÃ”NG.

ChÃºng ta Ä‘Ã£ biáº¿t ráº±ng `count` lÃ  má»™t háº±ng sá»‘ cá»§a má»™t render component. Event handlers "sáº½ tháº¥y" tráº¡ng thÃ¡i `count` tá»« nhá»¯ng láº§n render mÃ  chÃºng `thuá»™c` bá»Ÿi vÃ¬ `count` lÃ  má»™t biáº¿n trong pháº¡m vi cá»§a chÃºng. Äiá»u nÃ y cÅ©ng Ä‘Ãºng vá»›i effect!

**KhÃ´ng pháº£i biáº¿n `count` thÃ¬ báº±ng cÃ¡ch nÃ o thay Ä‘á»•i bÃªn trong má»™t hiá»‡u á»©ng thay Ä‘á»•i. Pháº£i lÃ  effect function cá»§a báº£n thÃ¢n nÃ³ khÃ¡c nhau sau má»—i láº§n render.**

Má»—i phiÃªn báº£n cá»§a `count` from render mÃ  nÃ³ thuá»™c:

```js
// During first render
function Counter() {
  // ...
  useEffect(
    // Effect function from first render
    () => {
      document.title = `You clicked ${0} times`;
    }
  );
  // ...
}

// After a click, our function is called again
function Counter() {
  // ...
  useEffect(
    // Effect function from second render
    () => {
      document.title = `You clicked ${1} times`;
    }
  );
  // ...
}

// After another click, our function is called again
function Counter() {
  // ...
  useEffect(
    // Effect function from third render
    () => {
      document.title = `You clicked ${2} times`;
    }
  );
  // ..
}
```

React nhá»› effect function báº¡n Ä‘Ã£ cung cáº¥p vÃ  cháº¡y nÃ³ sau khi xÃ³a cÃ¡c thay Ä‘á»•i Ä‘á»‘i vá»›i DOM vÃ  Ä‘á»ƒ trÃ¬nh duyá»‡t váº½ láº¡i mÃ n hÃ¬nh.

Quay láº¡i vá»›i pháº§n cáº­p nháº­p document title, nÃ³ Ä‘Æ°á»£c thá»ƒ hiá»‡n bá»Ÿi má»™t *function khÃ¡c* trong má»—i láº§n render - vÃ  má»—i effect function sáº½ nháº­n props vÃ  state cá»¥ thá»ƒ cá»§a nhá»¯ng láº§n render Ä‘Ã³.

**Vá» máº·t khÃ¡i niá»‡m, báº¡n cÃ³ thá»ƒ tÆ°á»Ÿng tÆ°á»£ng effect lÃ  má»™t pháº§n káº¿t quáº£ cá»§a render.**

Strictly saying, theyâ€™re not (in order to [allow Hook composition](https://overreacted.io/why-do-hooks-rely-on-call-order/) without clumsy syntax or runtime overhead). But in the mental model weâ€™re building up, effect functions *belong* to a particular render in the same way that event handlers do.

---
Äá»ƒ cháº¯c cháº¯n ráº±ng chÃºng ta hiá»ƒu, hÃ£y tÃ³m táº¯t láº¡i láº§n Ä‘áº§u tiÃªn render:

* **React:** ÄÆ°a tÃ´i UI khi state `count` báº±ng 0.
* **Your component:**
  * ÄÃ¢y lÃ  káº¿t quáº£ cá»§a render:
  `<p>You clicked 0 times</p>`.
  * VÃ  nhá»› lÃ  hÃ£y cháº¡y effect nÃ y sau khi render xong nhÃ©: `() => { document.title = 'You clicked 0 times' }`.
* **React:** Cháº¯c cháº¯n. UI Ä‘ang cáº­p nháº­p. Hey trÃ¬nh duyá»‡t, Tao Ä‘ang thÃªm má»™t vÃ i thá»© vÃ o DOM.
* **Browser:** Cool, Táº¡o Ä‘Ã£ váº½ nÃ³ lÃªn mÃ n hÃ¬nh.
* **React:** OK, Tao sáº½ cháº¡y effect mÃ y Ä‘Æ°a tao ngay bÃ¢y giá».
  * Running `() => { document.title = 'You clicked 0 times' }`.

---
BÃ¢y giá» hÃ£y tÃ³m táº¯t nhá»¯ng gÃ¬ xáº£y ra sau khi click

* **Your component:** Hey React, cho state cá»§a bá»‘ m lÃªn `1` Ä‘i.
* **React:** ÄÆ°a bá»‘ m UI khi state báº±ng `1` trÆ°á»›c Ä‘i.
* **Your component:**
  * ÄÃ¢y, cá»§a m cáº£:
  `<p>You clicked 1 times</p>`.
  * Nhá»› cho bá»‘ m lÃ  cháº¡y cÃ¡i nÃ y Ä‘Ã³: `() => { document.title = 'You clicked 1 times' }`.
* **React:** Biáº¿t rá»“i. Äang update UI rÃ¹i nhÃ©. ÃŠ trÃ¬nh duyá»‡t, Bá»‘ vá»«a thay Ä‘á»•i DOM.
* **Browser:** Cool, tao Ä‘Ã£ dá»±ng láº¡i mÃ n hÃ¬nh.
* **React:** OK, giá» t sáº½ cháº¡y effect láº§n nÃ y.
  * Running `() => { document.title = 'You clicked 1 times' }`.

---

## Má»—i Render Sáº½ CÃ³ RiÃªng ... Má»i Thá»©

**ChÃºng tÃ´i biáº¿t bÃ¢y giá» effect cháº¡y sau má»—i láº§n render, vá» máº·t khÃ¡i niá»‡m lÃ  má»™t pháº§n cá»§a component output, vÃ  tháº¥y Ä‘Æ°á»£c props, state cá»§a má»™t component cá»¥ thá»ƒ.**

HÃ£y thá»­ thá»­ nghiá»‡m má»™t chÃºt. Xem qua Ä‘oáº¡n code nÃ y:

```js
function Counter() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    setTimeout(() => {
      console.log(`You clicked ${count} times`);
    }, 3000);
  });

  return (
    <div>
      <p>You clicked {count} times</p>
      <button onClick={() => setCount(count + 1)}>
        Click me
      </button>
    </div>
  );
}
```
Náº¿u tÃ´i click vÃ i láº§n vá»›i khoáº£ng delay nhá», cÃ¡i gÃ¬ sáº½ hiá»‡n trÃªn log ?

---

*spoilers ahead*

---
Báº¡n cÃ³ thá»ƒ nghÄ© káº¿t quáº£ cá»§a Ä‘iá»u nÃ y khÃ´ng kháº£ quan. NhÆ°ng khÃ´ng! ChÃºng ta sáº½ nhÃ¬n láº§n lÆ°á»£t nhá»¯ng logs - má»—i cÃ¡i thuá»™c má»™t render cá»¥ thá»ƒ vÃ  vá»›i `count` cá»§a nÃ³. Báº¡n cÃ³ thá»ƒ [thá»­](https://codesandbox.io/s/lyx20m1ol):

![Screen recording of 1, 2, 3, 4, 5 logged in order](https://i.imgur.com/tc8OOr0.gif)

You may think: â€œOf course thatâ€™s how it works! How else could it work?â€


Well, Ä‘Ã¢y khÃ´ng pháº£i cÃ¡ch `this.state` hoáº¡t Ä‘á»™ng trong class component. Tháº­t dá»… dÃ ng Ä‘á»ƒ táº¡o ra lá»—i khi [triá»ƒn khai class](https://codesandbox.io/s/kkymzwjqz3):

```jsx
  componentDidUpdate() {
    setTimeout(() => {
      console.log(`You clicked ${this.state.count} times`);
    }, 3000);
  }
```

Tuy nhiÃªn, `this.state.count` luÃ´n luÃ´n trá» tá»›i tráº¡ng thÃ¡i cuá»‘i cÃ¹ng cá»§a `count` hay vÃ¬ cá»§a má»—i láº§n render. VÃ¬ tháº¿ báº¡n sáº½ tháº¥y 5 log nhÆ° tháº¿ nÃ y!

![Screen recording of 5, 5, 5, 5, 5 logged in order](https://i.imgur.com/Vn5bHeo.gif):

TÃ´i nghÄ©, tháº­t má»‰a mai khi Hooks phá»¥ thuá»™c quÃ¡ nhiá»u vÃ o Javascript Closure vÃ  nÃ³ 

I think itâ€™s ironic that Hooks rely so much on JavaScript closures, and yet itâ€™s the class implementation that suffers from [the canonical wrong-value-in-a-timeout confusion](https://wsvincent.com/javascript-closure-settimeout-for-loop/) thatâ€™s often associated with closures. This is because the actual source of the confusion in this example is the mutation (React mutates `this.state` in classes to point to the latest state) and not closures themselves.

**Closure tá»‘t khi values báº¡n khÃ´ng thay Ä‘á»•i. Äiá»u nÃ y khiáº¿n chÃºng ta dá»… dÃ ng suy nghÄ© vÃ¬ vá» cÆ¡ báº£n báº¡n Ä‘á» cÃ¢p tá»›i háº±ng sá»‘.** VÃ  nhÆ° chÃºng ta Ä‘Ã£ tháº£o luáº­n, props vÃ  state khÃ´ng thay Ä‘á»•i sau nhá»¯ng láº§n render. NhÃ¢n tiá»‡n, chÃºng ta cÃ³ thá»ƒ fix phiÃªn báº£n classs báº±ng cÃ¡ch [dÃ¹ng closure](https://codesandbox.io/s/w7vjo07055).

## Swimming Against the Tide

á» Ä‘iá»ƒm nÃ y, tháº­t quan trá»ng ráº±ng chÃºng ta gá»i nÃ³ bÃªn ngoÃ i rÃµ rÃ ng: **má»—i** function bÃªn trong component render (bao gá»“m cáº£ event handler, effect, timeout hoáº·c API call) sáº½ captures props and state cá»§a render mÃ  nÃ³ Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a. 

Vi váº­y, 2 vÃ­ dá»¥ ta sáº½ tÆ°Æ¡ng Ä‘Æ°Æ¡ng:

```jsx{4}
function Example(props) {
  useEffect(() => {
    setTimeout(() => {
      console.log(props.counter);
    }, 1000);
  });
  // ...
}
```

```jsx{2,5}
function Example(props) {
  const counter = props.counter;
  useEffect(() => {
    setTimeout(() => {
      console.log(counter);
    }, 1000);
  });
  // ...
}
```

**KhÃ´ng quan trá»ng viá»‡c báº¡n Ä‘á»c tá»« prop hay state bÃªn trong component cá»§a báº¡n.** ChÃºng khÃ´ng cÃ³ sá»± thay Ä‘á»•i. BÃªn trong pháº¡m vi cá»§a single render, props vÃ  state váº«n á»Ÿ Ä‘Ã³.

Táº¥t nhiÃªn, Ä‘Ã´i lÃºc báº¡n muá»‘n Ä‘á»c giÃ¡ trá»‹ cuá»‘i cÃ¹ng bÃªn trong má»™t vÃ i callback Ä‘á»‹nh nghÄ©a bÃªn trong effect. CÃ¡c tá»‘t nháº¥t vÃ  dá»… nháº¥t Ä‘á»ƒ lÃ m lÃ  sá»­ dá»¥ng refs, nhÆ° hÆ°Æ¡ng dáº«n á»Ÿ [bÃ i viáº¿t nÃ y](https://overreacted.io/how-are-function-components-different-from-classes/).

ÄÃ¢y lÃ  má»™t [phiÃªn báº£n cá»§a vÃ­ dá»¥ counter](https://codesandbox.io/s/rm7z22qnlp) mÃ  hÃ nh vi Ä‘Æ°á»£c cá»§a class Ä‘Æ°á»£c sao chÃ©p:

```jsx{3,6-7,9-10}
function Example() {
  const [count, setCount] = useState(0);
  const latestCount = useRef(count);

  useEffect(() => {
    // Set the mutable latest value
    latestCount.current = count;
    setTimeout(() => {
      // Read the mutable latest value
      console.log(`You clicked ${latestCount.current} times`);
    }, 3000);
  });
  // ...
```

![Screen recording of 5, 5, 5, 5, 5 logged in order](https://i.imgur.com/aCxGXmx.gif)

CÃ³ váº» ká»³ quáº·c Ä‘á»ƒ báº¥t biáº¿n má»™t cÃ¡i gÃ¬ Ä‘Ã³ trong React. Tuy nhiÃªn, Ä‘Ã¢y chÃ­nh xÃ¡c lÃ  cÃ¡ch mÃ  React tá»± gÃ¡n `this.state` cho chÃ­nh nÃ³ trong class component. KhÃ´ng giá»‘ng nhÆ° `capture` props vÃ  state, báº¡n khÃ´ng cÃ³ báº¥t kÃ¬ Ä‘iá»u gÃ¬ Ä‘áº£m báº£o ráº±ng  Ä‘á»c `lastestCount.current` sáº½ mang láº¡i cho báº¡n cÃ¹ng value bÃªn trong má»™t callback cá»¥ thá»ƒ.

>By definition, you can mutate it any time. This is why itâ€™s not a default, and you have to opt into that.

> END Phan 1
